<!DOCTYPE html>
<!-- Author: Thijs Lacquet -->
<!-- Provides the drawing via Javascript of the scanpath visualization -->
<html>
<head>
<meta>

<script>
	//Input data
    var timestamp = [28719,28802,29268,29568,29801,30118,30368,30551,30717,30884,31084,31217,31500,32116,
        32316,32616,32866,33116,33366,33565,33765,33982,34315,34831,35064,35248,35631,35981];
    var fixationIndex = [84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,
        108,109,110,111];
    var fixationDuration = [83,466,300,233,316,250,183,167,166,200,133,283,616,200,300,250,250,150,200,200,
        216,333,516,233,183,383,166,166];
    var mappedFixationPointX = [596,480,449,549,927,1108,506,538,645,768,711,735,634,813,691,1061,1108,
        1140,1162,1080,779,708,925,779,830,881,1044,918];
    var mappedFixationPointY = [362,265,219,351,435,544,300,325,516,1058,998,626,395,396,407,532,574,607,
        643,705,774,972,706,798,767,736,702,717,437,686,860,941,737,720,743,736,768,811,841,905,914,859,
        921,962];
	var aoi = [{x1:20, x2:926, y1:20, y2:580},{x1:966, x2:1630, y1:20, y2:580},
		{x1:20, x2:926, y1:620, y2:1180}, {x1:966, x2:1630, y1:620, y2:1180}];
    var imageFile = "../Provided_data/stimuli/05_Frankfurt_S1.jpg";
</script>

<!-- Place image on screen-->
<link rel="stylesheet" type="text/css" href="visualization.css">

<title>Scarfplot visualisation demo</title>
</head>
<body>
<div id="visContainer">
	<div id="visImgContainer">
			<img id="myImage">
	</div>
	<div id="visCanvasContainer">
		<canvas id="myCanvas"></canvas>
	</div>
</div>
<div id="scarfPlotContainer">
	<canvas id="scarfPlot"></canvas>
</div>

<script>
	function createColors(amount) {
		var colors = new Array(amount);
		var deltaColor = 360 / amount;
		var saturation = 100;
		var lightness = 50;

		for (var i = 0; i < amount; i++) {
			var hue = i * deltaColor;
			colors[i] = `hsl(${hue},${saturation}%,${lightness}%)`;
		}
		return colors;
	}

	function drawAoi(ctx, aoi, colors) {
		for(var i = 0; i < aoi.length; i++) {
			ctx.beginPath();
			ctx.rect(aoi[i].x1, aoi[i].y1, aoi[i].x2 - aoi[i].x1, aoi[i].y2 - aoi[i].y1);
			
			//Stroke
			ctx.globalAlpha = 1;
			ctx.strokeStyle = colors[i];
			ctx.lineWidth = 5;
			ctx.stroke();

			//Fill
			ctx.globalAlpha = 0.1;
			ctx.fillStyle = colors[i];
			ctx.fill();
		}
	}

	function isInAoi(currentAoi, currentPointX, currentPointY) {
		if ((currentAoi.x1 < currentPointX &&
			currentAoi.x2 > currentPointX) &&
			(currentAoi.y1 < currentPointY &&
			currentAoi.y2 > currentPointY)) {
			return true;
		} else {
			return false;
		}
	}

	function drawScarfPlot(scarfCtx, scarfPlot, aoi, mappedFixationPointX,
		mappedFixationPointY, timestamp, colors) {

		if (mappedFixationPointX.length != mappedFixationPointY.length &&
			mappedFixationPointX.length != timestamp.length) {
			throw("IllegalArgumentException");
		}

		var offSetX = 200;
		var userHeight = 100;

		var totalTime = 0;
		var n = mappedFixationPointX.length;
		scarfPlot.height = 500;

		var timestampZerod = new Array(n);
		for (var i = 0; i < n; i++) {
			timestampZerod[i] = timestamp[i] - timestamp[0];
		}

		//Pixels per unit of timestamp
		var deltaPixel = (scarfPlot.clientWidth - offSetX) / timestampZerod[n - 1]; 

		for (var i = 0; i < n - 1; i++) { //Loop over all transitions
			for (var j = 0; j < aoi.length; j++) { //Loop over all AOI's
				if (isInAoi(aoi[j], mappedFixationPointX[i], mappedFixationPointY[i])) {
					scarfCtx.beginPath();
					//Draw part of scarfplot
					scarfCtx.rect(deltaPixel * timestampZerod[i] + offSetX, 0,
						deltaPixel * (timestampZerod[i + 1] - timestampZerod[i]), userHeight);

					scarfCtx.fillStyle = colors[j];
					scarfCtx.fill();
					break;
				}
			}
		}

		//Add elements for one single user
		scarfCtx.beginPath();
		scarfCtx.strokeStyle = 'black';
		scarfCtx.lineWidth = 5;
		scarfCtx.rect(0, 0, offSetX, userHeight);
		scarfCtx.rect(offSetX, 0, scarfPlot.clientWidth - offSetX, userHeight);
		scarfCtx.stroke();

		scarfCtx.font = "30px Arial";
		scarfCtx.fillStyle = 'black';
		scarfCtx.textAlign = "center";
		scarfCtx.fillText("p1", offSetX / 2, userHeight / 2);
		
	}

	var img = document.getElementById('myImage');
	var canvas = document.getElementById('myCanvas');
	var visContainer = document.getElementById('visContainer');
	var visImgContainer = document.getElementById('visImgContainer');
	var scarfPlot = document.getElementById('scarfPlot');

    img.src = imageFile;	
	canvas.width = visContainer.clientWidth;
	canvas.height = visContainer.clientHeight;
	scarfPlot.width = scarfPlotContainer.clientWidth;

	var ctx = canvas.getContext("2d");
	var scarfCtx = scarfPlot.getContext("2d");

	var colors = createColors(aoi.length);
	
	drawAoi(ctx, aoi, colors);
	drawScarfPlot(scarfCtx, scarfPlot, aoi, mappedFixationPointX, mappedFixationPointY, timestamp, colors);
</script>

</body>
</html>